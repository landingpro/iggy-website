<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Zero-copy (de)serialization | Hyper-Efficient Message Streaming at Laser Speed.</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://iggy.apache.org/img//apache-iggy-light-bg0.5x.png"><meta data-rh="true" name="twitter:image" content="https://iggy.apache.org/img//apache-iggy-light-bg0.5x.png"><meta data-rh="true" property="og:url" content="https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Zero-copy (de)serialization | Hyper-Efficient Message Streaming at Laser Speed."><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-05-08T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/numinnex,https://github.com/hubcio"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization"><link data-rh="true" rel="alternate" href="https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization" hreflang="en"><link data-rh="true" rel="alternate" href="https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization","mainEntityOfPage":"https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization","url":"https://iggy.apache.org/blogs/2025/05/08/zero-copy-deserialization","headline":"Zero-copy (de)serialization","name":"Zero-copy (de)serialization","description":"Introduction","datePublished":"2025-05-08T00:00:00.000Z","author":[{"@type":"Person","name":"Grzegorz Koszyk","description":"Apache Iggy PPMC Member","url":"https://github.com/numinnex"},{"@type":"Person","name":"Hubert Gruszecki","description":"Apache Iggy PPMC Member","url":"https://github.com/hubcio"}],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://iggy.apache.org/blogs","name":"Blogs"}}</script><link rel="alternate" type="application/rss+xml" href="/blogs/rss.xml" title="Hyper-Efficient Message Streaming at Laser Speed. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blogs/atom.xml" title="Hyper-Efficient Message Streaming at Laser Speed. Atom Feed"><link rel="stylesheet" href="/assets/css/styles.00ae354b.css">
<script src="/assets/js/runtime~main.e3e00cf3.js" defer="defer"></script>
<script src="/assets/js/main.c8167fb7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/apache-iggy0.5x.png"><link rel="preload" as="image" href="/img/apache-iggy-light-bg0.5x.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/apache-iggy0.5x.png" alt="Apache Iggy" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/apache-iggy-light-bg0.5x.png" alt="Apache Iggy" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs">Blogs</a><a class="navbar__item navbar__link" href="/downloads">Downloads</a><a href="https://benchmarks.iggy.rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Benchmarks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.gg/C5Sux5NcRa" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://forms.gle/MAd1GjpPwCjwdEp58" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Feedback<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/apache/iggy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub ⭐ 2.8K<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/2025/06/06/connectors-runtime">Connectors runtime</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blogs/2025/05/08/zero-copy-deserialization">Zero-copy (de)serialization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/2025/02/17/transparent-benchmarks">Transparent Benchmarking with Apache Iggy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/2025/02/10/apache-incubator">Iggy joins the Apache Incubator</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/2024/10/28/technology-radar-and-currrent-goals">Iggy.rs - Technology Radar &amp; current goals</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Zero-copy (de)serialization</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-05-08T00:00:00.000Z">May 8, 2025</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/numinnex" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Grzegorz Koszyk</span></a></div><small class="authorTitle_nd0D" title="Apache Iggy PPMC Member">Apache Iggy PPMC Member</small><div class="authorSocials_rSDt"></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/hubcio" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Hubert Gruszecki</span></a></div><small class="authorTitle_nd0D" title="Apache Iggy PPMC Member">Apache Iggy PPMC Member</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Apache Iggy considers <strong>performance as one of its core principles</strong>. We take pride in being blazingly fast, as proof of that, we have made <strong><a href="https://iggy.apache.org/blogs/2025/02/17/transparent-benchmarks" target="_blank" rel="noopener noreferrer">benchmarking first-class citizen</a></strong>.</p>
<p><strong>Zero-copy schema</strong> was a natural next step in our high-performance journey, it was part of our roadmap for quite a while, until the day we have <strong><a href="https://github.com/apache/iggy/pull/1679" target="_blank" rel="noopener noreferrer">finally merged it</a></strong>. In this blog post, we will share our path to implementing it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="zero-copy-with-rkyv">Zero copy with rkyv<a href="#zero-copy-with-rkyv" class="hash-link" aria-label="Direct link to Zero copy with rkyv" title="Direct link to Zero copy with rkyv">​</a></h2>
<p>Our initial approach to zero copy was leveraging the existing <strong><a href="https://github.com/rkyv/rkyv" target="_blank" rel="noopener noreferrer">rkyv</a></strong> package which might or might not have been the best choice (more about it later). Using rkyv is pretty straightforward, as it revolves around three traits (<code>Archive</code>, <code>Serialize</code>, <code>Deserialize</code>), all three of which can be derived using derive macros, thus making our job pretty easy.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[derive(Archive, Deserialize, Serialize)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">IggyBatch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> start_offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> start_timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> end_offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> end_timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> messages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">IggyMessage</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Same traits are derived for <code>IggyMessage</code></p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[derive(Archive, Deserialize, Serialize)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">IggyMessage</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rkyv internally figures out the memory layout used for serialization, such that it can later on cast it back into its Archived form. (A couple bits of trivia: rkyv, when performing zero copy deserialization, turns the byte representation of your data into its Archived form, so instead of <code>IggyBatch</code> we receive <code>ArchivedIggyBatch</code>, rkyv has to reimplement certain complex types such as <code>Vec</code>, <code>HashMap</code> etc., and that’s why it yields back your type in Archived form.)
You can learn more about it by reading the <strong><a href="https://rkyv.org" target="_blank" rel="noopener noreferrer">rkyv book</a></strong>, or from this <strong><a href="https://www.youtube.com/watch?v=ON4z2LbTD-4" target="_blank" rel="noopener noreferrer">presentation</a></strong>.</p>
<p>After a further evaluation of <code>IggyBatch</code>, we found that while it was good enough, there was still room for improvement.
Imagine a scenario where the client sends a batch with 100 messages, the server receives it, turns it into Archived form, updates metadata fields, caches/persists it and sends an ack back to the client. The client sends a fetch request for 10 messages, the server receives the request, peeks into the cache, finds our batch of 100 messages and here is the tricky bit -
We would like to send back <strong>only a slice of the cached data</strong> (10 messages instead of 100), but due to rkyv&#x27;s memory layout, one cannot simply take a slice of those bytes and perform the transformation into its Archived form.</p>
<p>So rather than deriving rkyv&#x27;s traits to <code>IggyBatch</code>, we decided to refine our approach by working at the individual message level.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">IggyBatch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> start_offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> start_timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> end_offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> end_timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> messages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AlignedVec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// AlignedVec is custom type from rkyv, that represents a vector of bytes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We redesigned the IggyBatch structure so that the <code>messages</code> field now stores a byte representation of <code>Vec&lt;IggyMessage&gt;</code>, with each message prefixed by its 4-byte length. This approach allows us to traverse through the data, cast individual messages to its archived form, and perform some work on it.</p>
<p><img decoding="async" loading="lazy" alt="image" src="/assets/images/iggy_batch_schema_1-61b4d896b850e3d0ee08270f7db7c6b5.png" width="1600" height="664" class="img_ev3q"></p>
<p>By creating this frankenstein layout that combines length prefixes with rkyv&#x27;s memory layout, we&#x27;ve achieved the flexibility that we were aiming for, optimized for the most costly copies (messages), rather than the entire batch including its header.</p>
<p>One thing worth noting, rkyv requires buffer with your data to be aligned, going after rkyv book - “16-aligned memory should be sufficient.”, thus if you want to prefix your payload with any metadata, make sure that it doesn’t misalign your buffer, or you can opt-in the <code>unaligned</code> feature.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="beyond-rkyv">Beyond rkyv<a href="#beyond-rkyv" class="hash-link" aria-label="Direct link to Beyond rkyv" title="Direct link to Beyond rkyv">​</a></h2>
<p>Rkyv is a pretty “heavy” crate that spreads through your entire application from network schema to disk schema, partially coupling your own versioning with its. <strong>For many applications there is no way around this</strong>, as it is the most complete zero-copy deserialization crate, but we decided to implement a more lightweight solution that gives us control over the memory layout.</p>
<p>We’ve decided to still process messages individually, but have replaced length prefixes with a separate index vector.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">IggyBatch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// Remaining fields...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> indexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> messages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image" src="/assets/images/iggy_batch_schema_2-c7a5fc6158b838999c178ef8aea96089.png" width="1600" height="720" class="img_ev3q"></p>
<p>This index vector consists of bytes that, when deserialized form <code>u32</code> values that point to specific positions within the message data. Separating messages from indexes serves purpose beyond the scope of this blog post, but shortly, this index structure closely resembles what we use on the server for message lookup in the log. This in turn, later on <strong>allows us to efficiently reuse memory</strong>.</p>
<p>When iterating through the batch, <strong>we yield views</strong> instead of fully deserialized messages.</p>
<p>In case if we’d need to have <code>IggyMessage</code> deserialized, we can do it just in time, rather than eagerly, for example when client processes a fetched batch from the server.</p>
<p>This approach allows us to combine the flexibility of solution with length prefixes using rkyv as well as having the freedom of not depending on a 3rd party crate, in fact this solution looks fairly similar to serde partial zero copy deserialization.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarks">Benchmarks<a href="#benchmarks" class="hash-link" aria-label="Direct link to Benchmarks" title="Direct link to Benchmarks">​</a></h2>
<p>Now the part that all of you are probably most interested in - le benchmarks.</p>
<p>Those results come from an <strong>AWS i3en.3xlarge</strong> instance</p>
<p><strong>Before</strong></p>
<p><img decoding="async" loading="lazy" alt="image" src="/assets/images/no_zero_copy_producer-ffed3643f7efa9c5ac43a3ce4cba746c.png" width="3188" height="2264" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image" src="/assets/images/no_zero_copy_consumer-ae546079ca662038a43983969c9fa325.png" width="3186" height="2262" class="img_ev3q"></p>
<table><thead><tr><th style="text-align:left">No zero-copy</th><th style="text-align:center">tput</th><th style="text-align:center">p95</th><th style="text-align:center">p99</th><th style="text-align:center">avg</th></tr></thead><tbody><tr><td style="text-align:left">Producer</td><td style="text-align:center">1.7GB/s</td><td style="text-align:center">3.48ms</td><td style="text-align:center">4.23ms</td><td style="text-align:center">2.39ms</td></tr><tr><td style="text-align:left">Consumer</td><td style="text-align:center">2.1GB/s</td><td style="text-align:center">2.53ms</td><td style="text-align:center">2.93ms</td><td style="text-align:center">1.90ms</td></tr></tbody></table>
<p><strong>After</strong></p>
<p><img decoding="async" loading="lazy" alt="image" src="/assets/images/zero_copy_producer-6cd58f250a711fb170bba9091da38606.png" width="3194" height="2260" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image" src="/assets/images/zero_copy_consumer-b0a3206f473d6d13c8cc4fc8dfca3486.png" width="3192" height="2266" class="img_ev3q"></p>
<table><thead><tr><th style="text-align:left">Zero-copy</th><th style="text-align:center">tput</th><th style="text-align:center">p95</th><th style="text-align:center">p99</th><th style="text-align:center">avg</th></tr></thead><tbody><tr><td style="text-align:left">Producer</td><td style="text-align:center">2.4GB/s</td><td style="text-align:center">2.33ms</td><td style="text-align:center">2.59ms</td><td style="text-align:center">1.63ms</td></tr><tr><td style="text-align:left">Consumer</td><td style="text-align:center">4.0GB/s</td><td style="text-align:center">1.21ms</td><td style="text-align:center">1.46ms</td><td style="text-align:center">0.98ms</td></tr></tbody></table>
<p><strong>Almost 2 times higher throughput for reads (2,1GBps vs 4GBps), 40% higher throughput for writes (2,4GBps vs 1,7GBps), 2x better p99 latencies for reads (2.93ms vs 1,46 ms) and 63% better p99 latencies for writes (4.23ms vs 2.59ms).</strong></p>
<p>You can find more detailed comparisons on our <strong><a href="https://benchmarks.iggy.rs" target="_blank" rel="noopener noreferrer">benchmarking website</a></strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="concluding">Concluding<a href="#concluding" class="hash-link" aria-label="Direct link to Concluding" title="Direct link to Concluding">​</a></h2>
<p><strong>It was a lot of fun exploring the entire design space for our zero copy schema</strong>. Depending on the constraints one might end up with a completely different solution, in fact zero copy isn&#x27;t always the optimal approach, for example, if you&#x27;d like to read more about challenges that folks in embedded development have to overcome, check out <strong><a href="https://bsky.app/profile/jamesmunns.com/post/3lnqo5ykawc2r" target="_blank" rel="noopener noreferrer">this Bluesky post from James Munns</a></strong>, or more broadly his project <strong><a href="https://github.com/jamesmunns/postcard-rpc" target="_blank" rel="noopener noreferrer">postcard-rpc</a></strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next-for-iggy">What’s next for Iggy<a href="#whats-next-for-iggy" class="hash-link" aria-label="Direct link to What’s next for Iggy" title="Direct link to What’s next for Iggy">​</a></h2>
<p>Implementing zero-copy was a major milestone for us, but the train doesn’t slow down. Next in line is <strong>io_uring</strong> and <strong>thread per core shared nothing</strong> architecture. <strong><a href="https://www.reddit.com/r/rust/comments/1d35fsb/comment/l65wgnt/" target="_blank" rel="noopener noreferrer">We’ve already promised</a></strong> that we will publish more details about it once we have the results from our benchmark tests, so expect a highly technical blog post in near future.</p>
<p>For now <strong><a href="https://github.com/apache/iggy/tree/io_uring_monoio_runtime" target="_blank" rel="noopener noreferrer">we did a proof of concept long time ago</a></strong>, but realised a few things along the way that we would like to do differently. So we will. Iggy moves onward and upward! 🚀</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blogs/2025/06/06/connectors-runtime"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Connectors runtime</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blogs/2025/02/17/transparent-benchmarks"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Transparent Benchmarking with Apache Iggy</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#zero-copy-with-rkyv" class="table-of-contents__link toc-highlight">Zero copy with rkyv</a></li><li><a href="#beyond-rkyv" class="table-of-contents__link toc-highlight">Beyond rkyv</a></li><li><a href="#benchmarks" class="table-of-contents__link toc-highlight">Benchmarks</a></li><li><a href="#concluding" class="table-of-contents__link toc-highlight">Concluding</a></li><li><a href="#whats-next-for-iggy" class="table-of-contents__link toc-highlight">What’s next for Iggy</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/company/apache-iggy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/C5Sux5NcRa" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/ApacheIggy" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://bsky.app/profile/iggy.rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bluesky<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blogs">Blogs</a></li><li class="footer__item"><a href="https://github.com/apache/iggy" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://benchmarks.iggy.rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Benchmarks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div>Apache Iggy is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</div>
<div><br>
Copyright © 2025 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.</div>
<div><br>
Apache®, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</div></div></div></div></footer></div>
</body>
</html>